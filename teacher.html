<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root { --primary-color: #0d47a1; --bg-color: #f0f4f8; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); padding-bottom: 50px; }
        .card-summary { transition: transform 0.2s; }
        .card-summary:hover { transform: translateY(-5px); }
        
        .status-btn { border: 1px solid #dee2e6; background: white; color: #6c757d; width: 100%; border-radius: 5px; padding: 5px; font-size: 0.9rem; }
        .status-btn.active-ma { background-color: #198754; color: white; border-color: #198754; }
        .status-btn.active-sai { background-color: #ffc107; color: black; border-color: #ffc107; }
        .status-btn.active-la { background-color: #0dcaf0; color: white; border-color: #0dcaf0; }
        .status-btn.active-khad { background-color: #dc3545; color: white; border-color: #dc3545; }
        
        .student-row { transition: background 0.3s; }
        .student-row:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>

    <div class="modal fade" id="loginModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-lock"></i> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå</h5>
                </div>
                <div class="modal-body">
                    <input type="password" id="teacherPass" class="form-control text-center fs-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (1234)">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" onclick="checkPass()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-dark bg-primary shadow-sm mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-clipboard-check"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</span>
        </div>
    </nav>

    <div class="container" id="mainContent" style="display:none;">
        
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Slot)</label>
                        <select id="selectSlot" class="form-select" onchange="loadActivities()">
                            <option value="1">09:00 - 10:20 (Slot 1)</option>
                            <option value="2">10:30 - 11:50 (Slot 2)</option>
                            <option value="3">13:00 - 14:20 (Slot 3)</option>
                            <option value="4">14:30 - 15:50 (Slot 4)</option>
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-bold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</label>
                        <select id="selectActivity" class="form-select" onchange="loadStudents()">
                            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-2 mb-3 text-center" id="summaryArea" style="display:none;">
            <div class="col-3"><div class="card p-2 border-success border-2 bg-white"><h3 class="m-0 text-success" id="countMa">0</h3><small>‡∏°‡∏≤</small></div></div>
            <div class="col-3"><div class="card p-2 border-warning border-2 bg-white"><h3 class="m-0 text-warning" id="countSai">0</h3><small>‡∏™‡∏≤‡∏¢</small></div></div>
            <div class="col-3"><div class="card p-2 border-info border-2 bg-white"><h3 class="m-0 text-info" id="countLa">0</h3><small>‡∏•‡∏≤</small></div></div>
            <div class="col-3"><div class="card p-2 border-danger border-2 bg-white"><h3 class="m-0 text-danger" id="countKhad">0</h3><small>‡∏Ç‡∏≤‡∏î</small></div></div>
            <div class="col-12 text-muted small mt-1">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="countTotal">0</span> ‡∏Ñ‡∏ô</div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="m-0"><i class="bi bi-people"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0 align-middle">
                        <thead class="table-light text-center">
                            <tr>
                                <th width="5%">#</th>
                                <th width="15%">‡∏£‡∏´‡∏±‡∏™</th>
                                <th width="25%">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th width="15%">‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á</th>
                                <th width="40%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            </tr>
                        </thead>
                        <tbody id="studentTableBody">
                            <tr><td colspan="5" class="text-center py-5 text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==========================================
        // ‚ö†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase (‡πÉ‡∏ä‡πâ Key ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢)
        // ==========================================
        const SUPABASE_URL = 'https://pqkaqsxmbewilzruogdw.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxa2Fxc3htYmV3aWx6cnVvZ2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODgzMTksImV4cCI6MjA4NDA2NDMxOX0.TFyfNcFXcUUF29Iexmkjf6EaNIXAv8KuOFY_ydAY_z8'; 

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentStudents = [];

        // --- 1. Login ---
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        window.onload = () => { loginModal.show(); }

        function checkPass() {
            const pass = document.getElementById('teacherPass').value;
            if (pass === '1234') { // üî• ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏π (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
                loginModal.hide();
                document.getElementById('mainContent').style.display = 'block';
                loadActivities();
            } else {
                Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
            }
        }

        // --- 2. Load Activities ---
        async function loadActivities() {
            const slot = document.getElementById('selectSlot').value;
            document.getElementById('selectActivity').innerHTML = '<option>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>';
            
            try {
                // ‡∏î‡∏∂‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Slot ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                const { data, error } = await client
                    .from('activities')
                    .select('id, name')
                    .eq('slot', slot)
                    .order('name');
                
                if (error) throw error;

                let html = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° --</option>';
                data.forEach(act => {
                    html += `<option value="${act.id}">${act.name}</option>`;
                });
                document.getElementById('selectActivity').innerHTML = html;
            } catch (err) {
                console.error(err);
                Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            }
        }

        // --- 3. Load Students ---
        async function loadStudents() {
            const slot = document.getElementById('selectSlot').value;
            const actId = document.getElementById('selectActivity').value;
            const tbody = document.getElementById('studentTableBody');

            if (!actId) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</td></tr>';
                document.getElementById('summaryArea').style.display = 'none';
                return;
            }

            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary"></div></td></tr>';

            try {
                // Query: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ slotX_id ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ
                // ‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á status ‡∏Ç‡∏≠‡∏á slot ‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
                const { data, error } = await client
                    .from('registrations')
                    .select(`id, student_id, student_name, class_level, room, number, slot${slot}_status`)
                    .eq(`slot${slot}_id`, actId)
                    .order('class_level')
                    .order('room')
                    .order('number'); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà

                if (error) throw error;

                currentStudents = data;
                renderStudentTable(data, slot);
            } catch (err) {
                console.error(err);
                Swal.fire('Error', '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
            }
        }

        // --- 4. Render Table & Buttons ---
        function renderStudentTable(data, slot) {
            const tbody = document.getElementById('studentTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</td></tr>';
                updateSummary();
                return;
            }

            let html = '';
            data.forEach((std, index) => {
                // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô '‡∏°‡∏≤', '‡∏™‡∏≤‡∏¢')
                let status = std[`slot${slot}_status`] || '‡∏£‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ';

                html += `<tr class="student-row">
                    <td class="text-center">${index + 1}</td>
                    <td class="text-center">${std.student_id}</td>
                    <td>${std.student_name}</td>
                    <td class="text-center">‡∏°.${std.class_level}/${std.room} (${std.number})</td>
                    <td>
                        <div class="row g-1">
                            <div class="col-3"><button onclick="setStatus('${std.id}', ${slot}, '‡∏°‡∏≤', this)" class="status-btn ${status==='‡∏°‡∏≤'?'active-ma':''}">‡∏°‡∏≤</button></div>
                            <div class="col-3"><button onclick="setStatus('${std.id}', ${slot}, '‡∏™‡∏≤‡∏¢', this)" class="status-btn ${status==='‡∏™‡∏≤‡∏¢'?'active-sai':''}">‡∏™‡∏≤‡∏¢</button></div>
                            <div class="col-3"><button onclick="setStatus('${std.id}', ${slot}, '‡∏•‡∏≤', this)" class="status-btn ${status==='‡∏•‡∏≤'?'active-la':''}">‡∏•‡∏≤</button></div>
                            <div class="col-3"><button onclick="setStatus('${std.id}', ${slot}, '‡∏Ç‡∏≤‡∏î', this)" class="status-btn ${status==='‡∏Ç‡∏≤‡∏î'?'active-khad':''}">‡∏Ç‡∏≤‡∏î</button></div>
                        </div>
                    </td>
                </tr>`;
            });

            tbody.innerHTML = html;
            document.getElementById('summaryArea').style.display = 'flex';
            updateSummary(data, slot);
        }

        // --- 5. Update Status (Real-time) ---
        async function setStatus(uuid, slot, status, btnElement) {
            // 1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (UX)
            let parent = btnElement.parentElement.parentElement;
            let btns = parent.querySelectorAll('.status-btn');
            btns.forEach(b => {
                b.className = 'status-btn'; // Reset
            });
            
            // Add Active Class
            if(status === '‡∏°‡∏≤') btnElement.classList.add('active-ma');
            else if(status === '‡∏™‡∏≤‡∏¢') btnElement.classList.add('active-sai');
            else if(status === '‡∏•‡∏≤') btnElement.classList.add('active-la');
            else if(status === '‡∏Ç‡∏≤‡∏î') btnElement.classList.add('active-khad');

            // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Local Array (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Dashboard ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
            let student = currentStudents.find(s => s.id === uuid);
            if(student) {
                student[`slot${slot}_status`] = status;
                updateSummary(currentStudents, slot);
            }

            // 3. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Supabase (Background)
            try {
                const { error } = await client
                    .from('registrations')
                    .update({ [`slot${slot}_status`]: status })
                    .eq('id', uuid);

                if (error) throw error;
                // Success (‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏î‡πâ‡∏á Alert ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π)
            } catch (err) {
                console.error(err);
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'error',
                    title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏ô‡πá‡∏ï‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        }

        // --- 6. Calculate Summary ---
        function updateSummary(data, slot) {
            let ma = 0, sai = 0, la = 0, khad = 0;
            
            data.forEach(s => {
                let status = s[`slot${slot}_status`];
                if(status === '‡∏°‡∏≤') ma++;
                else if(status === '‡∏™‡∏≤‡∏¢') sai++;
                else if(status === '‡∏•‡∏≤') la++;
                else if(status === '‡∏Ç‡∏≤‡∏î') khad++;
            });

            document.getElementById('countTotal').innerText = data.length;
            document.getElementById('countMa').innerText = ma;
            document.getElementById('countSai').innerText = sai;
            document.getElementById('countLa').innerText = la;
            document.getElementById('countKhad').innerText = khad;
        }

    </script>
</body>
</html>
