<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบลงทะเบียนกิจกรรม Workshop - PSUWIT</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root { --primary-color: #0d47a1; --secondary-color: #1976d2; --bg-color: #f0f4f8; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--bg-color); min-height: 100vh; padding-bottom: 80px; }
        
        .banner-container {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; padding: 20px 0; border-radius: 0 0 25px 25px; margin-bottom: 30px;
        }
        .logo-circle { width: 90px; height: 90px; transition: transform 0.3s; }
        .logo-circle:hover { transform: scale(1.1); }

        .main-card { background: white; border-radius: 15px; padding: 30px; max-width: 600px; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        .btn-main { background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); color: white; border-radius: 50px; width: 100%; padding: 12px; font-weight: bold; border:none; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.2); color:white;}
        
        .table-container { background: white; border-radius: 15px; padding: 15px; overflow-x: auto; }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 5; border-right: 2px solid #dee2e6; min-width: 140px; }
        
        .slot-btn { width: 100%; padding: 4px; font-size: 0.75rem; border-radius: 6px; border: 1px solid #dee2e6; margin-bottom: 4px; min-height: 40px; }
        .btn-green { background-color: #f8fff9; color: #198754; border-color: #198754; }
        .btn-selected { background-color: var(--primary-color) !important; color: white !important; transform: scale(1.05); }
        .btn-full { background-color: #fdeaea; color: #dc3545; border-color: #f5c2c7; cursor: not-allowed; opacity: 0.7; }
        
        .footer-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; display: none; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        .badge-istem { background-color: #6f42c1; color: white; }
        .badge-teacher { background-color: #0dcaf0; color: black; }
        .badge-parent { background-color: #ffc107; color: black; }
        
        .receipt-card { border-top: 5px solid #198754; }
        
        @media (max-width: 576px) { .header-content { flex-direction: column; } }
    </style>
</head>
<body>

    <div class="banner-container">
        <div class="container d-flex justify-content-center align-items-center gap-3 flex-wrap header-content">
            <div class="text-center">
                <img src="https://img2.pic.in.th/pic/PSUWIT_Circle.png" class="logo-circle">
                <p class="mt-2 text-white-50 m-0">ระบบลงทะเบียนกิจกรรม workshop</p>
                <p class="mt-2 text-white-50 m-0">มอ.ว วิชาการ ครั้งที่ 3 ปีการศึกษา</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="loginSection" class="main-card">
            <h4 class="text-center mb-4 fw-bold" style="color: var(--primary-color);">
                <i class="bi bi-person-circle"></i> ข้อมูลนักเรียน
            </h4>
            <form onsubmit="checkAndGo(event)">
                <div class="mb-3">
                    <label>ชื่อ-นามสกุล</label>
                    <input type="text" id="inputName" class="form-control" required placeholder="เช่น นายรักเรียน เพียรศึกษา">
                </div>
                <div class="mb-3">
                    <label>รหัสนักเรียน</label>
                    <input type="text" id="inputId" class="form-control" required placeholder="กรอกเฉพาะตัวเลข">
                </div>
                <div class="row g-2 mb-4">
                    <div class="col-4">
                        <label>ชั้น</label>
                        <select id="inputClass" class="form-select" required>
                            <option value="">เลือก</option>
                            <option value="1">ม.1</option>
                            <option value="2">ม.2</option>
                            <option value="3">ม.3</option>
                            <option value="4">ม.4</option>
                            <option value="5">ม.5</option>
                            <option value="6">ม.6</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <label>ห้อง</label>
                        <select id="inputRoom" class="form-select" required>
                            <option value="">เลือก</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <label>เลขที่</label>
                        <input type="number" id="inputNumber" class="form-control" required>
                    </div>
                </div>
                <button type="submit" id="btnEnter" class="btn-main">เข้าสู่ระบบลงทะเบียน</button>
            </form>
        </div>

        <div id="selectionSection" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-primary fw-bold m-0">ระบบลงทะเบียนกิจกรรม workshop</h5>
                <span class="badge bg-white text-dark border p-2"><span id="displayName"></span> (ม.<span id="displayClass"></span>)</span>
            </div>
            <div class="alert alert-primary py-2 mb-3 small"><i class="bi bi-info-circle-fill"></i> เงื่อนไข: <strong id="userConditionText">...</strong></div>

            <div id="loading" class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">กำลังโหลด...</p></div>

            <div class="table-container" id="tableArea" style="display:none;">
                <table class="table table-bordered mb-0 w-100">
                    <thead class="table-dark text-center small">
                        <tr><th class="sticky-col">กิจกรรม</th><th width="19%">09:00 (Slot 1)</th><th width="19%">10:30 (Slot 2)</th><th width="19%">13:00 (Slot 3)</th><th width="19%">14:30 (Slot 4)</th></tr>
                    </thead>
                    <tbody id="activityTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="successSection" class="main-card receipt-card text-center" style="display:none;">
            
            <div id="captureArea" class="bg-white p-2">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                <h4 class="fw-bold mt-2 text-success">ลงทะเบียนสำเร็จ!</h4>
                <p class="text-muted small">บันทึกข้อมูลเข้าสู่ระบบเรียบร้อยแล้ว</p>
                
                <div class="card bg-light border-0 p-3 mb-3 text-start shadow-sm">
                    <div class="row">
                        <div class="col-6"><strong>ชื่อ:</strong> <span id="successName"></span></div>
                        <div class="col-6"><strong>รหัส:</strong> <span id="successId"></span></div>
                        <div class="col-12 mt-1"><strong>ชั้น:</strong> ม.<span id="successClass"></span>/ <span id="successRoom"></span> เลขที่ <span id="successNumber"></span></div>
                    </div>
                </div>

                <h6 class="fw-bold text-start mb-2"><i class="bi bi-calendar-check"></i> ตารางกิจกรรมที่เลือก</h6>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-primary">
                            <tr>
                                <th width="35%">เวลา</th>
                                <th>กิจกรรม</th>
                            </tr>
                        </thead>
                        <tbody id="successTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button class="btn btn-success rounded-pill fw-bold" onclick="saveAsImage()">
                    <i class="bi bi-download"></i> บันทึกผลเป็นรูปภาพ
                </button>
                <button class="btn btn-outline-secondary rounded-pill" onclick="location.reload()">
                    <i class="bi bi-house-door-fill"></i> กลับหน้าแรก
                </button>
            </div>

        </div>

    </div>

    <div class="footer-bar justify-content-between align-items-center" id="footerBar">
        <div id="statusText" class="fw-bold text-danger small">ยังเลือกไม่ครบ...</div>
        <button id="btnConfirm" disabled onclick="submitAll()" class="btn btn-secondary rounded-pill px-4 fw-bold">ยืนยันการลงทะเบียน</button>
    </div>

    <script>
        const SUPABASE_URL = 'https://pqkaqsxmbewilzruogdw.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxa2Fxc3htYmV3aWx6cnVvZ2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODgzMTksImV4cCI6MjA4NDA2NDMxOX0.TFyfNcFXcUUF29Iexmkjf6EaNIXAv8KuOFY_ydAY_z8'; 

        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let selections = { 1: null, 2: null, 3: null, 4: null }; 
        let studentInfo = {}; 

        // --- 1. เช็คสิทธิ์และเข้าสู่ระบบ ---
        async function checkAndGo(e) {
            e.preventDefault();
            
            studentInfo = {
                name: document.getElementById('inputName').value,
                id: document.getElementById('inputId').value.trim(),
                classLevel: document.getElementById('inputClass').value,
                room: document.getElementById('inputRoom').value,
                number: document.getElementById('inputNumber').value
            };

            let btn = document.getElementById('btnEnter');
            let originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> กำลังตรวจสอบ...';

            try {
                const { data, error } = await client
                    .from('registrations')
                    .select('student_id')
                    .eq('student_id', studentInfo.id)
                    .maybeSingle();

                if (error) throw error;

                if (data) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'ลงทะเบียนแล้ว',
                        text: 'รหัสนักเรียนนี้ลงทะเบียนเรียบร้อยแล้วครับ',
                        confirmButtonColor: '#0d47a1'
                    });
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                } else {
                    goToSelection();
                }
            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'ไม่สามารถเชื่อมต่อฐานข้อมูลได้', 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function goToSelection() {
            document.getElementById('displayName').innerText = studentInfo.name;
            document.getElementById('displayClass').innerText = studentInfo.classLevel;
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('selectionSection').style.display = 'block';
            
            let conditionText = "";
            if (studentInfo.classLevel == "1" || studentInfo.classLevel == "4") {
                conditionText = "ต้องมี ISTEM, Teacher, Parent ครบทุกกลุ่ม";
            } else {
                conditionText = "ต้องมี Teacher และ Parent (ห้ามเลือก ISTEM)";
            }
            document.getElementById('userConditionText').innerText = conditionText;

            try {
                const { data, error } = await client
                    .from('activity_counts')
                    .select('*');

                if (error) throw error;
                renderTable(data);
            } catch (err) {
                console.error(err);
                Swal.fire('Error', 'โหลดข้อมูลกิจกรรมไม่สำเร็จ', 'error');
            }
        }

        // --- 2. สร้างตาราง ---
        function renderTable(data) {
            let grouped = {};
            data.forEach(row => {
                let name = row.name;
                if (!grouped[name]) grouped[name] = { name: name, group: row.group_type, slots: {} };
                grouped[name].slots[row.slot] = row; 
            });

            let html = '';
            for (let key in grouped) {
                let item = grouped[key];
                let badgeClass = 'badge bg-secondary';
                if(item.group === 'ISTEM') badgeClass = 'badge badge-istem';
                else if(item.group === 'Teacher') badgeClass = 'badge badge-teacher';
                else if(item.group === 'Parent') badgeClass = 'badge badge-parent';

                html += `<tr>`;
                html += `<td class="sticky-col bg-white border-end p-2">
                            <div class="fw-bold small">${item.name}</div>
                            <span class="${badgeClass}">${item.group}</span>
                        </td>`;
                
                for (let s = 1; s <= 4; s++) {
                    let slotData = item.slots[s];
                    html += `<td class="text-center p-1 align-middle">`;
                    if (slotData) {
                        let id = slotData.id; 
                        let max = slotData.max_seats;
                        let reg = slotData.current_seats;
                        let remain = max - reg;
                        
                        if (remain <= 0) {
                            html += `<button class="slot-btn btn-full" disabled>เต็ม</button>`;
                        } else {
                            let safeName = item.name.replace(/'/g, "\\'");
                            let btnId = `btn_s${s}_${id}`;
                            html += `<button id="${btnId}" class="slot-btn btn-green" 
                                    data-remain="${remain}"
                                    onclick="selectSlot(${s}, '${id}', '${safeName}', '${item.group}')">
                                    <span class="d-block fw-bold">${remain}</span>
                                    <span style="font-size:0.6rem">ว่าง</span>
                                    </button>`;
                        }
                    } else {
                        html += `<span class="text-muted small">-</span>`;
                    }
                    html += `</td>`;
                }
                html += `</tr>`;
            }
            document.getElementById('activityTableBody').innerHTML = html;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableArea').style.display = 'block';
            document.getElementById('footerBar').style.display = 'flex';
        }

        // --- 3. ระบบเลือกวิชา ---
        function selectSlot(slot, id, name, group) {
            const nonIstemLevels = ["2", "3", "5", "6"];
            if (nonIstemLevels.includes(studentInfo.classLevel) && group === "ISTEM") {
                Swal.fire({
                    icon: 'warning',
                    title: 'เลือกไม่ได้',
                    text: 'ระดับชั้นของคุณไม่สามารถเลือกกิจกรรม ISTEM ได้ครับ',
                    confirmButtonColor: '#ffc107',
                });
                return;
            }

            if (selections[slot] && selections[slot].id === id) {
                selections[slot] = null;
                updateUI(slot, id, false);
                validateAndCheck();
                return;
            }
            for (let s = 1; s <= 4; s++) {
                if (s !== slot && selections[s] && selections[s].name === name) {
                    Swal.fire({icon: 'warning', title: 'ซ้ำ!', text: `วิชา "${name}" ถูกเลือกไปแล้ว`, confirmButtonColor: '#ffc107'});
                    return;
                }
            }
            if (selections[slot]) {
                let oldId = selections[slot].id;
                updateUI(slot, oldId, false);
            }
            selections[slot] = { id: id, name: name, group: group };
            updateUI(slot, id, true);
            validateAndCheck();
        }

        function updateUI(slot, id, isSelected) {
            let btnId = `btn_s${slot}_${id}`;
            let btn = document.getElementById(btnId);
            if (btn) {
                let remain = btn.getAttribute('data-remain');
                btn.className = 'slot-btn'; 
                if (isSelected) {
                    btn.classList.add('btn-selected');
                    btn.innerHTML = `<i class="bi bi-check-lg"></i> เลือก`;
                } else {
                    btn.classList.add('btn-green');
                    btn.innerHTML = `<span class="d-block fw-bold">${remain}</span><span style="font-size:0.6rem">ว่าง</span>`; 
                }
            }
        }

        // --- 4. ตรวจสอบเงื่อนไข ---
        function validateAndCheck() {
            let count = 0;
            let groups = { 'ISTEM': 0, 'Teacher': 0, 'Parent': 0 };

            for (let s = 1; s <= 4; s++) {
                if (selections[s]) {
                    count++;
                    if (groups[selections[s].group] !== undefined) groups[selections[s].group]++;
                }
            }

            let statusDiv = document.getElementById('statusText');
            let btn = document.getElementById('btnConfirm');
            
            let isTimeComplete = (count === 4);
            let isGroupValid = false;
            let missing = [];

            let isMustHaveISTEM = (studentInfo.classLevel == "1" || studentInfo.classLevel == "4");

            if (isMustHaveISTEM) {
                if (groups['ISTEM'] >= 1 && groups['Teacher'] >= 1 && groups['Parent'] >= 1) isGroupValid = true;
                else {
                    if (groups['ISTEM'] == 0) missing.push("ISTEM");
                    if (groups['Teacher'] == 0) missing.push("Teacher");
                    if (groups['Parent'] == 0) missing.push("Parent");
                }
            } else {
                if (groups['Teacher'] >= 1 && groups['Parent'] >= 1) isGroupValid = true;
                else {
                    if (groups['Teacher'] == 0) missing.push("Teacher");
                    if (groups['Parent'] == 0) missing.push("Parent");
                }
            }

            if (!isTimeComplete) missing.unshift("เวลาไม่ครบ");

            if (isTimeComplete && isGroupValid) {
                statusDiv.innerHTML = `<span class="text-success"><i class="bi bi-check-circle-fill"></i> ครบถ้วนพร้อมส่ง!</span>`;
                btn.disabled = false;
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
            } else {
                statusDiv.innerHTML = "ขาด: " + missing.join(", ");
                statusDiv.classList.add('text-danger');
                btn.disabled = true;
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            }
        }

        // --- 5. บันทึกและแสดงผล ---
        function submitAll() {
            Swal.fire({
                title: 'ยืนยันการลงทะเบียน?',
                text: "ตรวจสอบข้อมูลให้ถูกต้องก่อนส่งนะครับ",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#0d47a1',
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'กำลังบันทึกข้อมูล...',
                        allowOutsideClick: false,
                        didOpen: () => { Swal.showLoading(); }
                    });

                    const payload = {
                        student_name: studentInfo.name,
                        student_id: studentInfo.id,
                        class_level: studentInfo.classLevel,
                        room: studentInfo.room,
                        number: studentInfo.number,
                        slot1_id: selections[1].id,
                        slot2_id: selections[2].id,
                        slot3_id: selections[3].id,
                        slot4_id: selections[4].id
                    };

                    try {
                        const { error } = await client
                            .from('registrations')
                            .insert([payload]);

                        if (error) throw error;

                        Swal.fire({
                            icon: 'success', 
                            title: 'สำเร็จ!', 
                            text: 'บันทึกข้อมูลเรียบร้อยแล้ว', 
                            confirmButtonColor: '#198754'
                        }).then(() => {
                            showSuccessPage(payload);
                        });

                    } catch (err) {
                        console.error(err);
                        if (err.code === '23505') { 
                             Swal.fire({icon: 'error', title: 'ผิดพลาด', text: 'รหัสนักเรียนนี้ลงทะเบียนไปแล้ว'});
                        } else {
                             Swal.fire({icon: 'error', title: 'เกิดข้อผิดพลาด', text: err.message});
                        }
                    }
                }
            });
        }

        // --- 6. แสดงหน้าสรุป ---
        function showSuccessPage(data) {
            document.getElementById('selectionSection').style.display = 'none';
            document.getElementById('footerBar').style.display = 'none';
            document.getElementById('successSection').style.display = 'block';

            document.getElementById('successName').innerText = data.student_name;
            document.getElementById('successId').innerText = data.student_id;
            document.getElementById('successClass').innerText = data.class_level;
            document.getElementById('successRoom').innerText = data.room;
            document.getElementById('successNumber').innerText = data.number;

            let html = '';
            const times = {
                1: '09:00 - 10:30',
                2: '10:30 - 12:00',
                3: '13:00 - 14:30',
                4: '14:30 - 16:00'
            };

            for(let i=1; i<=4; i++) {
                if(selections[i]) {
                    html += `<tr>
                        <td class="bg-light align-middle">
                            <span class="badge bg-secondary mb-1">Slot ${i}</span><br>
                            <span class="small">${times[i]}</span>
                        </td>
                        <td class="text-start align-middle">
                            <div class="fw-bold text-primary">${selections[i].name}</div>
                            <span class="badge bg-info text-dark" style="font-size:0.7rem">${selections[i].group}</span>
                        </td>
                    </tr>`;
                }
            }
            document.getElementById('successTableBody').innerHTML = html;
            window.scrollTo(0, 0);
        }

        // --- 7. ฟังก์ชันบันทึกภาพ ---
        function saveAsImage() {
            Swal.fire({
                title: 'กำลังสร้างรูปภาพ...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            // เลือกเฉพาะส่วนที่จะแคป (id="captureArea")
            const element = document.getElementById("captureArea");
            
            html2canvas(element, { 
                scale: 2, // เพิ่มความชัด 2 เท่า
                backgroundColor: "#ffffff" // พื้นหลังขาว
            }).then(canvas => {
                Swal.close();
                
                // สร้างลิงก์ดาวน์โหลด
                const link = document.createElement('a');
                link.download = `Result_${studentInfo.id}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();

                // แจ้งเตือนเผื่อดาวน์โหลดไม่ได้
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกแล้ว',
                    text: 'หากรูปไม่ขึ้น ให้ลองแคปหน้าจอแทนนะครับ',
                    timer: 3000
                });
            });
        }
    </script>
</body>
</html>
